# HTTP Platform Cookbook

__Maintainer: OIT Systems Engineering__ (<ua-oit-se@alaska.edu>)

## Purpose

Configures an HTTPS server with a certificate and secure cypher and protocol suites.
This cookbook configures only frontend nodes; load balancers, proxies, backends and everything else is out of scope.
Custom conf files can be injected to add such things as needed.

This cookbook is intended as a base for rapidly building websites and as such favors convention over configuration.

* Every host _redirects_ HTTP requests to HTTPS
* Multiple host names are supported, but hosts are little more than name aliases
* Host share these attributes
  * Certificate - all host names are listed as subject alternative names on the certificate
  * Redirects - these are generated per hostname
  * Rewrite rules - these are generated per hostname
  * Error documents
  * Configs
  * Content (root and access directories)
* Host are distinguished by
  * Log files
  * Log levels

Currently only Apache is supported.

Host names are always populated as plain-www pairs and each pair shares logging, so either plain, www, or both hosts can be listed.

While convention is favored over configuration, almost all logic is placed in an auxiliary config file that is included in bare-minimum virtual hosts.
For example:

```text
<VirtualHost *:443>
  ServerName www.funny.business

  ErrorLog ${APACHE_LOG_DIR}/funny.business.error.log
  CustomLog ${APACHE_LOG_DIR}/funny.business.access.log combined
  LogLevel warn

  Include conf.d/ssl-host.conf
</VirtualHost>
```

This allows the host-enumeration logic in this cookbook to be used with entirely custom configurations.
See `node['http_platform']['apache']['paths_to_additional_configs']` below.

Three sources are supported for certificates.
The cookbook always creates a private key, Self-Signed (SS) certificate, and Certificate Signing Request (CSR).
By default, the hosts are configured to use the SS certificate for encryption.

A trusted certificate can also be fetched from Lets Encrypt.
This method uses the Certbot utility to complete an ACME challenge from the certificate authority so the server must be world visible to use this method.

Lastly, a certificate can be fetched from the Chef server as a Vault secret.
Typically, the CSR generated by this cookbook will be sent to a certificate authority to obtain a trusted certificate.
Otherwise, if a key-CSR pair is generated by other means, the private key can be included in the vault item and used for encryption.

If multiple certificates are configured, the hosts will use the certificate with highest precedence.
Precedence is as follows.

`Vault > Lets Encrypt > Self Signed`

ToDo:

* Automatic stapling
* Additional access directories
* Additional access files

## Requirements

### Chef

This cookbook requires Chef 14+

### Platforms

Supported Platform Families:

* Debian
  * Ubuntu, Mint
* Red Hat Enterprise Linux
  * Amazon, CentOS, Oracle

Platforms validated via Test Kitchen:

* Ubuntu
* CentOS

### Dependencies

This cookbook does not constrain its dependencies because it is intended as a utility library.  It should ultimately be used within a wrapper cookbook.

## Resources

This cookbook provides no custom resources.

## Recipes

### http_platform::default

This recipe configures the server, encryption, hosts, and access.
Several additional recipes are called to accomplish these tasks, but only this recipe should be included by clients.

#### Attributes

__default__

Default attributes control the features of the platform.

* `node['http_platform']['configure_firewall']`.
Defaults to `true`.
Determines if the firewall is configured.
* `node['http_platform']['configure_cert']`.
Defaults to `true`.
Determines if a private key, self-signed certificate, CSR, and possibly other certificates are created.
* `node['http_platform']['configure_apache']`.
Defaults to `true`.
Determines if the Apache HTTP server is installed and configured.
Disabling this permits the certificate-handling logic to be used with, for example, Nginx.
Note that Apache must be configured to use Certbot to fetch a trusted certificate.

These flags control trusted certificate usage.
These attributes have no effect if `node['http_platform']['configure_cert']` is `false`.
See above for certificate precedence.

* `node['http_platform']['configure_vault_cert']`.
Defaults to `false`.
Determines if a certificate is fetched from Chef vault.
* `node['http_platform']['configure_lets_encrypt_cert']`.
Defaults to `false`.
Determines if a certificate is fetching using Certbot.
Requires Apache running on a world-visible server.

Several attributes control security.
The philosophy of this cookbook is to be optimistic and allow new ciphers and protocols to be added as time goes on.
This is done by defining support in the negative: start with a candidate list and remove unsecure items.
This is done mostly to reduce the burden of managing a platform-dependent list of supported ciphers over time.

* `node['http_platform']['cipher_generator']`.
Defaults to `'HIGH:!aNULL:!kRSA:!SHA:@STRENGTH'`.
This is the string used to generate a list of candidate ciphers using [OpenSSL](https://www.openssl.org/docs/man1.1.0/apps/ciphers.html).
The precise list of ciphers generated depends on both OpenSSL version and compile options and will be specific to a distribution.
The meaning of this string is 'All ciphers that use encryption with "high" strength rating - but not null authentication, RSA key exchange, or SHA hashing - ordered by strength'.
This generator is sufficient to generate a tight cipher suite on Ubuntu 18, Ubuntu 16, or CentOS 7.
Older distros may require more exclusions.
* `node['http_platform']['ciphers_to_remove']`.
Defaults to `['-CBC-']`.
This is a list of regular expressions.
Any cipher matching one or more of these regexes will be removed from the final list of ciphers.
This attribute is used primarily to remove algorithms that cannot be specified as a group, as is done with `kRSA` above.
By default, any cipher that uses [cipher block chaining](https://en.wikipedia.org/wiki/Block_cipher_mode_of_operation) will be removed.
* `node['http_platform']['ssl_protocol']`.
Defaults to `'All -SSLv2 -SSLv3 -TLSv1 -TLSv1.1'`.
This is the string used to specify protocol versions to be used.
On Ubuntu 18, Ubuntu 16 and CentOS 7 this results in only TLSv1.2.
TLSv1.3 will be automatically supported when it becomes available but explicit TLSv1.3 is not commonly supported at this time.
Note that `node.default['apache']['mod_ssl']['ssl_protocol']` is set to the value of `node['http_platform']['ssl_protocol']` within a recipe.
* `node['http_platform']['apache']['use_stapling']`.
Defaults to `'off'`.
This must not be enabled unless a trusted certificate is configured.
* `node['http_platform']['apache']['paths_to_additional_configs']`.
Defaults to `{ 'conf.d/ssl-host.conf' => '' }`.
A hash of relative paths to additional config files to be included by all HTTPS hosts.
The default is the config file generated based on the attributes of this cookbook.
Most clients will merge this hash to add additional configs as desired, but an entirely custom host configuration is hereby supported.

The default security settings are sufficient to earn an 'A' grade on [Qualys SSL Server Test](https://www.ssllabs.com/ssltest/).
If compatibility is a concern, the ciphers should be loosened.
For high-traffic servers, less costly ciphers are advisable.

__apache__

Apache attributes control the server configuration.

* `node['http_platform']['apache']['install_test_suite']`.
Defaults to `false`.
If true, installs support for running `apachectl fullstatus` for troubleshooting.
This includes a command-line browser (elinks) and the Apache status module.
Because 'localhost' will redirect to the default HTTPS host, to perform local testing it is advisable to either poison the hosts file on the host machine or to explicitly specify HTTPS protocol (and port if forwarded), e.g. 'https://localhost:8043'.

* `node['http_platform']['apache']['extra_mods_to_install']`.
Defaults to `{}`.
A hash of Apache mods to install; e.g. `{ 'wsgi -> '' }`.
Modules 'headers', 'rewrite', and 'ssl' are always installed.
Include the mod name only, e.g. 'php', without prefix 'mod_' or suffix '_mod'
See the [Apache cookbook](https://github.com/sous-chefs/apache2#recipes) for a list of modules

* `node['http_platform']['admin_email']`.
Defaults to `nil`.
This must be set or an exception is raised.
This also serves as the default email for the CSR.
Note that `node.default['apache']['contact']` is set to the value of `node['http_platform']['admin_email']` within a recipe.

__cert__

Cert attributes specify the fields of the PKI certificate and the parameters of the private key.

* `node['http_platform']['cert']['expiration_days']`.
Defaults to `365`.
The number of days until expiration for the SS certificate and and the CSR.
* `node['http_platform']['cert']['rsa_bits']`.
Defaults to `2048`.
The number of bits in the private key.
Currently only RSA keys are supported.
* `node['http_platform']['cert']['dh_param']['bits']`.
Defaults to `2048`.
The number of bits used for the Diffie-Hellman (DH) key exchange.
Currently DH is configured only on Debian-based distros.

The attributes below are given defaults but should typically be changed.

* `node['http_platform']['cert']['country']`.
Defaults to `'US'`.
The host country.
* `node['http_platform']['cert']['state']`.
Defaults to `'Alaska'`.
The host state, clients will typically want to override this:)
* `node['http_platform']['cert']['locale']`.
Defaults to `'Fairbanks'`.
The host city.
Almost surely not correct for a client.

The following attributes must be set if the cert is being created.

* `node['http_platform']['cert']['organization']`.
Defaults to `nil`.
The name of the host organization.
* `node['http_platform']['cert']['org_unit']`.
Defaults to `nil`.
The name of the unit, e.g. division, hosting the machine.

The attributes below default to reasonable values.

* `node['http_platform']['cert']['common_name']`.
Defaults to `nil`.
If nil, the FQDN of the node is used.
* `node['http_platform']['cert']['email']`.
Defaults to `nil`.
If nil, the value of `node['http_platform']['admin_email']` is used.

The attributes below control fetching of a certificate from a server vault.

* `node['http_platform']['cert']['vault_data_bag']`.
Defaults to `'certs'`.
The name of the vault data bag from which to fetch the certificate.
* `node['http_platform']['cert']['vault_bag_item']`.
Defaults to `nil`.
The item inside the data bag (json file).
If nil, Defaults to the FQDN of the node.
* `node['http_platform']['cert']['vault_item_key']`.
Defaults to `'cert'`.
The key for the certificate within the json object.
* `node['http_platform']['key']['vault_item_key']`.
Defaults to `nil`.
The key for the private key within the json object.
This will typically be nil because the generated CSR will be used to create a certificate for the generated private key.
However, a key will be manually placed on the system if this is non-nil, e.g. for use in Test Kitchen.

__firewall__

Firewall attributes control firewall settings.

* `node['http_platform']['firewall']['enable_http']`.
Defaults to `true`.
Determines if world-accessible HTTP is allowed.

World-accessible HTTPS is _always_ allowed.
If custom HTTP/HTTPS rules are desired, e.g. remote access from only specific CIDRs, then `node['http_platform']['configure_firewall']` can be set to `false` and the desired rules created elsewhere.

Please note:

* This cookbook uses the [firewall cookbook](https://github.com/chef-cookbooks/firewall) to create firewall rules so will conflict with other methods if configured.
* An SSH rule __must__ be created outside of this cookbook or communication will be lost to the node after this cookbook is run. The `firewall::default` rule is used to initialize the firewall, and this recipe respects all attributes of the [firewall cookbook](https://github.com/chef-cookbooks/firewall).
Notably, a world-accessible SSH rule can be created by setting `node['firewall']['allow_ssh']` to `true`.

__www__

WWW settings configure the application and hosts.

* `node['http_platform']['www']['document_root']`.
Defaults to `'/var/www/html'`.
The absolute path to the directory where web documents are located.

* `node['http_platform']['www']['remove_default_index']`.
Defaults to `true`.
Some distributions provide a default document at $HTTP_HOST/index.html.
If this flag is true any such document will be removed.
* `node['http_platform']['www']['create_default_index']`.
Defaults to `false`.
If true an extremely simple html page will be created at $HTTP_HOST/index.html.
This can be used for initial troubleshooting.
This setting overrides `node['http_platform']['www']['remove_default_index']`.

* `node['http_platform']['www']['access_directories']`.
Defaults to `{ '/' => '' }`.
A hash of directories and files to which to allow http access.
Each key is a relative path from `node['http_platform']['www']['document_root']` to the directory.
Each value is a single file in that directory.
To allow access recursively to all files in the directory, use an empty string as the file name.

* `node['http_platform']['www']['error_documents']`.
Defaults to `{}`.
A mapping of status code => relative path to error document, e.g. { 404 => '/404_kitten.php' }.
Error documents are shared by all hosts.

* `node['http_platform']['www']['additional_aliases']`.
Defaults to `{}`.
This cookbook always creates plain (default host) and www hosts for the FQDN.
This is a map of additional hosts to options, e.g. { 'other.url' => { 'log_level' -> 'info' } }.
Options can also be set for the FQDN host by including that as well.
If both the plain and www host are included, these are treated as independent and can be given different options.
Otherwise the plain and www hosts will be created as a matched pair with identical options.
The options currently recognized are:
  * 'log_level'.
  Defaults to 'warn'.
  See the [Apache documentation](https://httpd.apache.org/docs/2.4/mod/core.html#loglevel).
  * 'log_prefix'.
  Defaults to the plain host name.
  For example, on Ubuntu the default access log for 'www.other.url' will be '/var/log/apache2/other.url.access.log'.

* `node['http_platform']['www']['redirect_rules']`.
Defaults to `[]`.
This is an array of haches representing redirect rules; these will be matched first to last.
The fields of a rule are:
  * 'comment'.
  Optional.
  Will be placed above the rule.
  * 'from_regex'.
  Required.
  The regex for the incoming URL.
  * 'to_regex'.
  Required.
  The regex for the target URL.

* `node['http_platform']['www']['rewrite_rules']`.
Defaults to `[]`.
An array of hashes representing rewrite rules; these will be matched first to last.
Rewrite rules are evaluated after redirect rules.
This attribute only generates 'RewriteRule' entries.
For other rewrite logic custom config files must be used.
This attribute will eventually support generating both Apache and Nginx configs for the range of logic it supports.
The fields of a rule are:
  * 'comment'.
  Optional.
  Will be placed above the rule.
  * 'url_regex'.
  Required.
  The regex for the URL.
  * 'path_regex'.
  Required.
  The regex for the generated relative file path.
  * 'flags'.
  Optional.
  The flags for the rule, e.g. '[L,NC]'.
  See the [Apache documentation](https://httpd.apache.org/docs/2.4/rewrite/flags.html).

## Examples

This is an application cookbook; no custom resources are provided.  See recipes and attributes for details of what this cookbook does.

## Development

See CONTRIBUTING.md and TESTING.md.
